# syntax=docker/dockerfile:1

############################
# Base image & OS setup (CUDA)
############################
FROM nvidia/cuda:12.2.2-runtime-ubuntu22.04

# Avoid interactive apt prompts
ENV DEBIAN_FRONTEND=noninteractive

# Explicit HOME (for root at build time)
ENV HOME=/root

# Core packages: FUSE, tini, tools needed by Miniforge & Jupyter, rclone
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      ca-certificates \
      wget \
      git \
      bzip2 \
      fuse3 \
      rclone \
      curl \
      tini \
      nano \
      locales && \
    rm -rf /var/lib/apt/lists/*

# Allow non-root (if you ever switch) to use `-o allow_other` with FUSE mounts
RUN echo "user_allow_other" >> /etc/fuse.conf || true

# UTF-8 locale
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8 \
    LC_ALL=en_US.UTF-8

############################
# FUSE / rclone helper
############################
# Make absolutely sure a "fusermount3" command exists in PATH
RUN if ! command -v fusermount3 >/dev/null 2>&1 && command -v fusermount >/dev/null 2>&1; then \
      ln -s "$(command -v fusermount)" /usr/local/bin/fusermount3; \
    fi

# Hint rclone which helper to use (not strictly required but nice)
ENV RCLONE_FUSE_COMMAND=fusermount3

############################
# Miniforge / conda
############################
# Miniforge (conda) to /opt/conda
ENV CONDA_DIR=/opt/conda
COPY docker/Miniforge3-Linux-x86_64.sh /tmp/miniforge.sh

RUN bash /tmp/miniforge.sh -b -p ${CONDA_DIR} && \
    rm /tmp/miniforge.sh

# Put conda on PATH
ENV PATH=${CONDA_DIR}/bin:${PATH}

# Use bash for RUN steps from here on
SHELL ["bash", "-lc"]

# Make conda non-interactive and a bit nicer
RUN conda config --system --set always_yes yes --set changeps1 false && \
    conda config --system --set show_channel_urls true

# Install JupyterLab & ipykernel into base env using conda (non-interactive)
RUN conda install -n base jupyterlab ipykernel && \
    conda clean -afy

# ðŸ”¹ Install NVDashboard in the same base env as JupyterLab
RUN conda install -n base -c conda-forge jupyterlab-nvdashboard && \
    conda clean -afy

############################
# Project environment
############################
# Project env name + location
ENV PROJECT_ENV_NAME=MRSI_simulation
ENV PROJECT_ENV_DIR=/opt/conda/envs/${PROJECT_ENV_NAME}

# Expect env file under root's home (copied below)
ENV PROJECT_ENV_FILE=${HOME}/env/MRSI_simulation.yml

# Ensure directory for the env file exists
RUN mkdir -p "$(dirname "${PROJECT_ENV_FILE}")"

# Copy conda environment file from build context (project-root/env/...)
COPY env/MRSI_simulation.yml ${PROJECT_ENV_FILE}

# Create project env as a NAMED env (shows up in `conda env list`)
RUN conda env create \
      -n "${PROJECT_ENV_NAME}" \
      -f "${PROJECT_ENV_FILE}" \
      -y && \
    conda clean -afy

# ðŸ”¹ Ensure ipykernel is installed in the project env itself
RUN conda install -n "${PROJECT_ENV_NAME}" ipykernel -y && \
    conda clean -afy

# ðŸ”¹ Register a Jupyter kernel for the project env SYSTEM-WIDE (no --user)
#    This makes a kernelspec under /usr/local/share/jupyter/kernels/MRSI_simulation
#    which points to /opt/conda/envs/MRSI_simulation/bin/python
RUN conda run -n "${PROJECT_ENV_NAME}" python -m ipykernel install \
      --name "${PROJECT_ENV_NAME}" \
      --display-name "Python (${PROJECT_ENV_NAME})" \
      --prefix=/usr/local

############################
# Helper scripts
############################
# Helper start script: init conda + activate project env
RUN mkdir -p /usr/local/bin && \
    cat << 'EOF' > /usr/local/bin/start.sh
#!/bin/bash
set -e

# If HOME points to something we can't write (e.g. /root for a non-root UID),
# move HOME to a neutral, world-writable workspace.
if [ -z "$HOME" ] || [ ! -d "$HOME" ] || [ ! -w "$HOME" ]; then
    export HOME=/workspace
fi
mkdir -p "$HOME"
cd "$HOME"

# Put per-user conda config somewhere accessible (and override any bad CONDARC)
export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
mkdir -p "$XDG_CONFIG_HOME/conda"
export CONDARC="$XDG_CONFIG_HOME/conda/.condarc"
touch "$CONDARC" 2>/dev/null || true

# Load conda
source /opt/conda/etc/profile.d/conda.sh

echo "Available conda envs at startup:"
conda env list || true
echo

# Try to activate project env by name
if conda env list | grep -q "^[^#]*MRSI_simulation"; then
    echo "Activating conda env: $PROJECT_ENV_NAME"
    conda activate "$PROJECT_ENV_NAME" || {
        echo "Failed to activate named env, trying prefix: $PROJECT_ENV_DIR"
        conda activate "$PROJECT_ENV_DIR" || export PATH="$PROJECT_ENV_DIR/bin:$PATH"
    }
else
    echo "Project env $PROJECT_ENV_NAME not found."
    echo "Falling back to base conda env."
    conda activate base || true
fi

echo "Using python: $(which python)"
python -c "import sys; print('sys.prefix:', sys.prefix)" || true
echo

exec "$@"
EOF

# Helper script to start JupyterLab (runs inside active env)
RUN cat << 'EOF' > /usr/local/bin/start-jupyter.sh
#!/bin/bash
set -e

jupyter lab \
  --ip=0.0.0.0 \
  --port="${JUPYTER_PORT:-8888}" \
  --no-browser \
  --notebook-dir="${HOME}"
EOF

RUN chmod +x /usr/local/bin/start.sh /usr/local/bin/start-jupyter.sh

############################
# Final setup: workdir, entrypoint
############################
# This is harmless; kept from previous setups
RUN mkdir -p /opt/envs

# Generic workspace that arbitrary UIDs can use
RUN mkdir -p /workspace && chmod 777 /workspace

# Tell conda to only use /opt/conda dirs (avoid /root/.conda/*)
ENV CONDA_ENVS_DIRS=/opt/conda/envs
ENV CONDA_PKGS_DIRS=/opt/conda/pkgs

# Default working directory: neutral, not /root
WORKDIR /workspace

# Expose Jupyter default port (optional but nice)
EXPOSE 8888

# Entrypoint: tini -> start.sh (which activates env) -> your command
ENTRYPOINT ["/usr/bin/tini", "--", "/usr/local/bin/start.sh"]

# Default command: interactive shell (already inside MRSI_simulation env, if present)
CMD ["bash"]

