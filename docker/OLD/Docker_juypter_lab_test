# Base image: CUDA 12.2 runtime on Ubuntu 22.04
FROM nvidia/cuda:12.2.2-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive

# System tools + tini + curl + rclone
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        wget \
        git \
        ca-certificates \
        bash \
        tini \
        curl \
        rclone && \
    rm -rf /var/lib/apt/lists/*

# Create non-root user "monkey"
ARG USERNAME=monkey
ARG UID=1000
ARG GID=1000

RUN groupadd -g ${GID} ${USERNAME} && \
    useradd -m -u ${UID} -g ${GID} -s /bin/bash ${USERNAME}

ENV HOME=/home/${USERNAME}

# Miniforge (conda/mamba) to /opt/conda
ENV CONDA_DIR=/opt/conda
COPY docker/Miniforge3-Linux-x86_64.sh /tmp/miniforge.sh

RUN bash /tmp/miniforge.sh -b -p ${CONDA_DIR} && \
    rm /tmp/miniforge.sh

# Put conda/mamba on PATH
ENV PATH=${CONDA_DIR}/bin:${PATH}

# Install JupyterLab into base conda env
RUN conda install -y jupyterlab ipykernel && \
    conda clean -afy

# Project env + repo locations
ENV PROJECT_ENV_DIR=/opt/envs/MRSI_simulation
ENV PROJECT_ENV_FILE=/workspace/env/MRSI_simulation.yml

# Use bash for RUN steps
SHELL ["bash", "-lc"]

# Helper start script: init conda + activate project env if present
RUN mkdir -p /usr/local/bin && \
    cat << 'EOF' > /usr/local/bin/start.sh
#!/bin/bash
set -e

# Load conda
source /opt/conda/etc/profile.d/conda.sh

# Try to activate project env if it exists
if [ -d "$PROJECT_ENV_DIR" ]; then
    echo "Activating conda env at: $PROJECT_ENV_DIR"
    conda activate "$PROJECT_ENV_DIR" || export PATH="$PROJECT_ENV_DIR/bin:$PATH"
else
    echo "Project env directory $PROJECT_ENV_DIR does not exist yet."
    echo "Using base conda env. To create the project env, run:"
    echo "  mamba env create -p $PROJECT_ENV_DIR -f $PROJECT_ENV_FILE"
    conda activate base || true
fi

exec "$@"
EOF

# Helper script to start JupyterLab
RUN cat << 'EOF' > /usr/local/bin/start-jupyter.sh
#!/bin/bash
set -e

# At this point, start.sh has already:
#  - loaded conda
#  - activated the project env (or base)
# So we just start JupyterLab.

jupyter lab \
  --ip=0.0.0.0 \
  --port="${JUPYTER_PORT:-8888}" \
  --no-browser \
  --notebook-dir=/workspace
EOF

RUN chmod +x /usr/local/bin/start.sh /usr/local/bin/start-jupyter.sh

# Create workspace and fix ownership
RUN mkdir -p /workspace && \
    chown -R ${USERNAME}:${USERNAME} /workspace /home/${USERNAME} /opt/envs || true

# Switch to non-root user
USER ${USERNAME}

# Default working directory: project workspace (mounted repo)
WORKDIR /workspace

# Expose Jupyter default port (optional but nice)
EXPOSE 8888

# Entrypoint: tini -> start.sh (which activates env) -> your command
ENTRYPOINT ["/usr/bin/tini", "--", "/usr/local/bin/start.sh"]

# Default command: interactive shell
CMD ["bash"]
